name: cortex_xdm_field_mapping
priority: 10
transformations:
- id: window_linux_mapping
  type: set_state
  key: dataset_preset
  val: datamodel dataset::xdr_data
  rule_conditions:
  - type: logsource
    product: windows
- id: juniper_data_mapping
  type: set_state
  key: dataset_preset
  val: dataset::juniper_juniper_raw
  rule_conditions:
  - type: logsource
    product: juniper

- id: window_linux_mapping_field
  type: field_name_mapping
  mapping:
        CommandLine: xdm.source.process.command_line
        User: xdm.source.user.username
        Company: xdm.source.process.company
        Data: xdm.source.process.command_line
        Description: xdm.event.description
        ScriptBlockText: xdm.source.process.command_line
        Details: xdm.event.description
        EventID: xdm.event.id
        EventType: xdm.event.type
        FileName: xdm.target.file.filename
        Image: xdm.source.process.name
        c-useragent: xdm.source.user_agent
        ImageLoaded: xdm.target.module.filename
        IpAddress: xdm.source.ipv4
        LogonType: xdm.logon.type
        OriginalFileName: xdm.source.process.executable.filename
        ParentCommandLine: xdr_data.causality_actor_process_command_line
        ParentImage: xdr_data.causality_actor_process_image_path
        ParentUser: xdr_data.causality_actor_effective_username
        Product: xdr_data.actor_process_signature_product
        RegistryValueName:
            - xdr_data.action_registry_value_name
            - xdm.target.registry.data
        SubjectUserName: xdm.source.user.username
        TargetFilename: xdm.target.file.filename
        TargetObject: xdm.target.registry.key
        TicketEncryptionType: xdm.auth.kerberos_tgs.encryption_type
        host.ip: xdm.source.ipv4
        program: xdm.source.process.name
        payload: xdm.event.description
        msg: xdm.event.description
  rule_conditions:
  - type: logsource
    product: windows
    
- id: mac_mapping_field
  type: field_name_mapping
  mapping:
        CommandLine: xdm.source.process.command_line
        User: xdm.source.user.username
        Company: xdm.source.process.company
        Data: xdm.source.process.command_line
        Description: xdm.event.description
        ScriptBlockText: xdm.source.process.command_line
        Details: xdm.event.description
        EventID: xdm.event.id
        EventType: xdm.event.type
        FileName: xdm.target.file.filename
        Image: xdm.source.process.name
        c-useragent: xdm.source.user_agent
        ImageLoaded: xdm.target.module.filename
        IpAddress: xdm.source.ipv4
        LogonType: xdm.logon.type
        OriginalFileName: xdm.source.process.executable.filename
        ParentCommandLine: xdr_data.causality_actor_process_command_line
        ParentImage: xdr_data.causality_actor_process_image_path
        ParentUser: xdr_data.causality_actor_effective_username
        Product: xdr_data.actor_process_signature_product
        RegistryValueName:
            - xdr_data.action_registry_value_name
            - xdm.target.registry.data
        SubjectUserName: xdm.source.user.username
        TargetFilename: xdm.target.file.filename
        TargetObject: xdm.target.registry.key
        TicketEncryptionType: xdm.auth.kerberos_tgs.encryption_type
        host.ip: xdm.source.ipv4
        program: xdm.source.process.name
        payload: xdm.event.description
        msg: xdm.event.description
  rule_conditions:
  - type: logsource
    product: macos
    
- id: linux_mapping_field
  type: field_name_mapping
  mapping:
        CommandLine: xdm.source.process.command_line
        User: xdm.source.user.username
        Company: xdm.source.process.company
        Data: xdm.source.process.command_line
        Description: xdm.event.description
        ScriptBlockText: xdm.source.process.command_line
        Details: xdm.event.description
        EventID: xdm.event.id
        EventType: xdm.event.type
        FileName: xdm.target.file.filename
        Image: xdm.source.process.name
        c-useragent: xdm.source.user_agent
        ImageLoaded: xdm.target.module.filename
        IpAddress: xdm.source.ipv4
        LogonType: xdm.logon.type
        OriginalFileName: xdm.source.process.executable.filename
        ParentCommandLine: xdr_data.causality_actor_process_command_line
        ParentImage: xdr_data.causality_actor_process_image_path
        ParentUser: xdr_data.causality_actor_effective_username
        Product: xdr_data.actor_process_signature_product
        RegistryValueName:
            - xdr_data.action_registry_value_name
            - xdm.target.registry.data
        SubjectUserName: xdm.source.user.username
        TargetFilename: xdm.target.file.filename
        TargetObject: xdm.target.registry.key
        TicketEncryptionType: xdm.auth.kerberos_tgs.encryption_type
        host.ip: xdm.source.ipv4
        DestinationHostname: xdm.target.host.hostname
        DestinationIp: xdm.target.ipv4 
        DestinationPort: xdm.target.port  
        keywords: xdm.source.process.command_line
        program: xdm.source.process.name
        payload: xdm.event.description
        msg: xdm.event.description
        cidr: xdm.target.subnet
  rule_conditions:
  - type: logsource
    product: linux

- id: mde_mapping
  type: field_name_mapping
  mapping:
        ActionType:
            - xdm.event.original_event_type
            - xdm.event.operation
        InitiatingProcessFileName: xdm.source.process.executable.filename
        InitiatingProcessFolderPath: xdm.source.process.executable.path
  rule_conditions:
  - type: logsource
    product: mde
- id: juniper_mapping
  type: field_name_mapping
  mapping:
        _raw: _raw_log
        dst_port: xdm.target.port
  rule_conditions:
  - type: logsource
    product: juniper
- id: network_mapping
  type: field_name_mapping
  mapping:
        _raw: _raw_log
        host: XDM_ALIAS.hostname
        message: xdm.event.description
  rule_conditions:
  - type: logsource
    product: network_device
- id: databrick_mapping
  type: field_name_mapping
  mapping:
        OperationName: azure_databricks_raw.operation_name
        UserAgent: azure_databricks_raw.user_agent
        SourceIPAddress: xdm.source.ipv4
  rule_conditions:
  - type: logsource
    product: azure
    service: databricks.accounts
- id: proxy_mapping
  type: field_name_mapping
  mapping:
        cs-host: xdm.network.http.domain
        cs-method: xdm.network.http.method
        cs-useragent: xdm.source.user_agent
        c-useragent: xdm.source.user_agent
        cs-request-body: xdm.event.description
        cs-uri-query: xdm.event.description
        dst_port: xdm.target.port 
  rule_conditions:
  - type: logsource
    category: proxy

- id: firewall_mapping
  type: field_name_mapping
  mapping:
        src_port: xdm.source.port 
        dst_port: xdm.target.port 
  rule_conditions:
  - type: logsource
    category: firewall
- id: dns_mapping
  type: field_name_mapping
  mapping:
        query: xdm.network.dns.dns_question.name
        record_type: xdm.network.dns.dns_resource_record.name 
        answer:  xdm.network.dns.is_response   
  rule_conditions:
  - type: logsource
    category: dns
    
- id: webserver_mapping
  type: field_name_mapping
  mapping:
        cs-host: xdm.network.http.domain
        cs-method: xdm.network.http.method
        cs-request-body: xdm.event.description
        cs-uri-query: xdm.event.description
        sc-status: xdm.network.http.response_code
        c-uri: xdm.network.http.url
        cs-uri: xdm.network.http.url
        c-ip: xdm.source.ipv4
        cs-uri-stem: xdm.network.http.url
  rule_conditions:
  - type: logsource
    category: webserver

- id: aws_cloudtrail_mapping
  type: field_name_mapping
  mapping:
        eventSource: xdm.event.outcome_reason
        eventName: xdm.event.operation
        userIdentity.arn: xdm.source.user.identifier
        sourceIPAddress: xdm.source.ipv4
        requestParameters.userName: xdm.target.user.username
        userIdentity.principalId: xdm.source.user.identifier
        errorCode: xdm.event.outcome_reason
        errorMessage: xdm.event.description
        recipientAccountId: xdm.target.cloud.account_id
        awsRegion: xdm.source.cloud.region
        userAgent: xdm.source.user_agent
        requestParameters.bucketName: xdm.target.resource.name
        resources: xdm.target.resource.id
  rule_conditions:
  - type: logsource
    product: aws
    service: cloudtrail

- id: azure_activity_mapping
  type: field_name_mapping
  mapping:
        ActivityType: xdm.event.operation
        Operation: xdm.event.operation
        CategoryValue: xdm.event.type
        OperationName: xdm.event.operation
        ResourceProviderValue: xdm.target.resource.type
        Status: xdm.event.outcome
        SubStatus: xdm.event.outcome_reason
        Caller: xdm.source.user.identifier
        CallerIpAddress: xdm.source.ipv4
        SubscriptionId: xdm.target.cloud.account_id
        ResourceGroup: xdm.target.resource.name
        ClientIP: xdm.source.ipv4
  rule_conditions:
  - type: logsource
    product: azure

- id: azure_signin_mapping
  type: field_name_mapping
  mapping:
        UserPrincipalName: xdm.source.user.username
        AppDisplayName: xdm.target.resource.name
        IPAddress: xdm.source.ipv4
        ResultType: xdm.event.outcome_reason
        DeviceDetail.deviceId: xdm.source.host.device_id
        Location.city: xdm.source.location.city
        Location.countryOrRegion: xdm.source.location.country
        AuthenticationRequirement: xdm.auth.auth_method
        ConditionalAccessStatus: xdm.event.outcome
        RiskLevelDuringSignIn: xdm.alert.severity
  rule_conditions:
  - type: logsource
    product: azure
    service: signin_logs

- id: gcp_audit_mapping
  type: field_name_mapping
  mapping:
        protoPayload.methodName: xdm.event.operation
        protoPayload.serviceName: xdm.event.outcome_reason
        protoPayload.authenticationInfo.principalEmail: xdm.source.user.username
        protoPayload.requestMetadata.callerIp: xdm.source.ipv4
        protoPayload.resourceName: xdm.target.resource.name
        resource.type: xdm.target.resource.type
        severity: xdm.alert.severity
        protoPayload.status.message: xdm.event.description
        logName: xdm.event.log_name
  rule_conditions:
  - type: logsource
    product: gcp
    service: audit

- id: okta_mapping
  type: field_name_mapping
  mapping:
        eventType: xdm.event.operation
        displayMessage: xdm.event.description
        actor.alternateId: xdm.source.user.username
        client.ipAddress: xdm.source.ipv4
        client.userAgent.rawUserAgent: xdm.source.user_agent
        outcome.result: xdm.event.outcome
        outcome.reason: xdm.event.outcome_reason
        target.displayName: xdm.target.user.username
        target.alternateId: xdm.target.user.username
        debugContext.debugData.requestUri: xdm.network.http.url
        authenticationContext.externalSessionId: xdm.network.session_id
  rule_conditions:
  - type: logsource
    product: okta

- id: zeek_smb_mapping
  type: field_name_mapping
  mapping:
        path: xdm.target.file.path
        name: xdm.target.file.filename
        size: xdm.target.file.size
        operation: xdm.event.operation
        id.orig_h: xdm.source.ipv4
        id.resp_h: xdm.target.ipv4
        id.orig_p: xdm.source.port
        id.resp_p: xdm.target.port
  rule_conditions:
  - type: logsource
    product: zeek
    service: smb_files

- id: zeek_general_mapping
  type: field_name_mapping
  mapping:
        path: xdm.target.file.path
        name: xdm.target.file.filename
        id.orig_h: xdm.source.ipv4
        id.resp_h: xdm.target.ipv4
        id.orig_p: xdm.source.port
        id.resp_p: xdm.target.port
  rule_conditions:
  - type: logsource
    product: zeek
- id: replace_quote
  type: replace_string
  regex: "^(\\*\\\\.+\\\\\\*)$"
  replacement: "\\1"
- id: add_condition
  type: add_condition
  conditions:
    test: winevent
  rule_conditions:
  - type: logsource
    product: juniper
postprocessing:
  - id: replace_query_pattern
    type: replace
    pattern: "dataset=juniper_juniper_raw"
    replacement: "dataset=juniper_juniper_raw | alter test = _raw_log"
    rule_conditions:
      - type: logsource
        product: juniper
